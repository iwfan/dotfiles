# Modern tmux configuration
# Save this as ~/.tmux.conf

# ============================================================================
# General Settings
# ============================================================================

# Set default shell with Homebrew PATH
set -g default-command "/bin/zsh"
set-environment -g PATH "/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

# Use true color support optimized for Ghostty
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-ghostty:Tc"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colors

# Enable RGB color support
set -ga terminal-features ",xterm-ghostty:RGB"

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase scrollback buffer size
set -g history-limit 50000

# Display tmux messages for 4 seconds
set -g display-time 4000

# Refresh status line more often
set -g status-interval 5

# Focus events enabled for terminals that support them
set -g focus-events on

# Super useful when using "grouped sessions" and multi-monitor setup
setw -g aggressive-resize on

# ============================================================================
# Key Bindings
# ============================================================================

# Set dual prefix keys: Ctrl-a (primary) and Ctrl-b (secondary for Ghostty keybinds)
# set -g prefix2 C-a
# bind C-a send-prefix -2

# Reload configuration
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

unbind '"'
unbind %
unbind c
unbind x
bind c new-window -c "#{pane_current_path}"
# Split panes using | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind x confirm kill-pane
bind X confirm kill-window

# Switch panes using Alt-arrow without prefix
bind -n M-Left resize-pane -L 5
bind -n M-Right resize-pane -R 5
bind -n M-Up resize-pane -U 5
bind -n M-Down resize-pane -D 5

# Vim-like pane switching
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Quick window selection
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# Copy mode improvements
setw -g mode-keys vi
bind v copy-mode # enter copy mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi C-v send -X rectangle-toggle

# ============================================================================
# Color Palette (Gruvbox Material)
# ============================================================================

# Define color variables for easy customization
# color_bg="#282828" # Main background
# color_fg="#e2cca9" # Main foreground
# color_accent="#a89984"       # Blue accent (active elements)
# color_gray_dark=colour241    # Dark gray (borders)
# color_gray_medium=colour245 # Medium gray (inactive text)
# color_gray_light="#504945"   # Light gray (secondary background)
# color_text_secondary="#e2cca9" # Secondary text color

# ============================================================================
# Color Palette (Everforest)
# ============================================================================
color_bg="#2E383C"           # Main background
color_fg="#272e33"           # Main foreground
color_accent="#a7c080"       # Blue accent (active elements)
color_gray_dark="#495156"    # Dark gray (borders)
color_gray_medium="#859289"  # Medium gray (inactive text)
color_gray_light="#414b50"   # Light gray (secondary background)
color_text_secondary="#9da9a0" # Secondary text color

# ============================================================================
# Status Bar Design (Ghostty Theme)
# ============================================================================

# Status bar colors - using defined variables
set -g status-style bg=$color_bg,fg=$color_fg

# Window status
setw -g window-status-format " #I:#W "
setw -g window-status-current-format "#[fg=$color_accent,bg=$color_bg]#[fg=$color_bg,bg=$color_accent,bold] #I:#W #[fg=$color_accent,bg=$color_bg] "

# 当前活动窗口 - 明显的蓝色背景
setw -g window-status-current-style bg=$color_accent,fg=$color_bg,bold

# 所有未选中窗口 - 统一灰色文字
setw -g window-status-style bg=$color_bg,fg=$color_gray_medium,none

# 强制覆盖所有特殊状态的样式，统一为灰色
setw -g window-status-last-style bg=$color_bg,fg=$color_gray_medium,none
setw -g window-status-activity-style bg=$color_bg,fg=$color_gray_medium,none
setw -g window-status-bell-style bg=$color_bg,fg=$color_gray_medium,none

# Pane border - subtle gray for inactive, blue for active
set -g pane-border-style fg=$color_gray_dark
set -g pane-active-border-style fg=$color_accent

# Message text
set -g message-style bg=$color_gray_light,fg=$color_accent

# Status bar position
set -g status-position bottom
set -g status-justify centre

# Status left - session name with blue accent
set -g status-left-length 30
set -g status-left "#[fg=$color_bg,bg=$color_accent,bold] #S #[fg=$color_accent,bg=$color_gray_light]#[fg=$color_text_secondary,bg=$color_gray_light,nobold] W%V/#(date +%G-12-28 | xargs -I {} date -j -f %Y-%m-%d {} +%V 2>/dev/null || date -d $(date +%G-12-28) +%V 2>/dev/null || echo 52) #[fg=$color_gray_light,bg=$color_bg] "

# Status right - 显示周数和星期（动态计算总周数）
set -g status-right-length 30
set -g status-right "#[fg=$color_gray_light,bg=$color_bg]#[fg=$color_text_secondary,bg=$color_gray_light] %H:%M #[fg=$color_accent,bg=$color_gray_light]#[fg=$color_bg,bg=$color_accent,bold] %a "

# Window status separator
setw -g window-status-separator ""

# ============================================================================
# Additional Features
# ============================================================================

# Don't exit copy mode on mouse drag end
unbind -T copy-mode-vi MouseDragEnd1Pane

# Easier and faster switching between next/prev window
bind C-p previous-window
bind C-n next-window

# Toggle popup window (can be hidden and reopened)
bind Space if-shell -F '#{==:#{session_name},popup}' {
    detach-client
} {
    # run-shell "tmux kill-session -t popup 2>/dev/null || true";
    display-popup -d '#{pane_current_path}' -E -w 80% -h 80% "tmux attach-session -t popup || tmux new-session -s popup \\; set-option -t popup status off"
}

# Source .tmux.conf as suggested in `man tmux`
bind R source-file ~/.tmux.conf

# Enable activity alerts
setw -g monitor-activity on
set -g visual-activity off

# Automatically set window title
setw -g automatic-rename on
set -g set-titles on

# No delay for escape key press
set -sg escape-time 0
